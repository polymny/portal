<div id="loggedin" style="display: none;">
    <a class="button is-rounded is-polymny" href="{{ config.extra.polymny_url | safe }}"><strong>Ouvrir Polymny</strong></a>
</div>

<form id="login" style="display: none;">
    <div id="loginnotification" style="display:none;" class="notification is-danger has-text-left"></div>
    <div class="field is-grouped is-grouped-centered">
        <div class="columns is-desktop">
            <div class="column is-narrow p-2"><input class="input" type="text" id="loginusername" placeholder="Nom d'utilisateur" required></div>
            <div class="column is-narrow p-2"><input class="input" type="password" autocomplete="current-password" id="loginpassword" placeholder="Mot de passe" required></div>
            <div class="column is-narrow p-2"><button type="submit" class="button is-rounded is-polymny" value="Ouvrir Polymny" id="loginbutton"><strong>Ouvrir Polymny</strong></button></div>
        </div>
    </div>
    <div class="field is-grouped is-grouped-centered">
        <div class="control"><a id="opennewpassword" href="#" onclick="return false;">Mot de passe oublié ?</a></div>
        {% if not config.extra.disable_registration %}
            <div class="control"><a id="opensignup" href="#" onclick="return false;">Pas encore inscrit ?</a></div>
        {% endif %}
</div>
</form>

<form id="hiddenform" action="{{ config.extra.polymny_url | safe }}login" style="display: none;" method="POST">
    <input id="hiddenusername" type="text" name="username">
    <input id="hiddenpassword" type="password" name="password">
</form>

<form id="newpassword" class="form" style="display: none;">
    <div id="newpasswordsuccess" style="display:none;" class="notification is-polymny has-text-left">
        Un e-mail contenant un lien permettant de réinitialiser votre mot de passe vous a été envoyé.
    </div>
    <div id="newpasswordnotification" style="display:none;" class="notification is-danger has-text-left">Une erreur inconnue s'est produite</div>
    <div class="field is-grouped is-grouped-centered">
        <p class="control">
            <input id="newpasswordemail" class="input" type="email" placeholder="Adresse e-mail" required>
        </p>
        <p class="control">
            <button id="newpasswordbutton" type="submit" class="button is-polymny is-rounded"><strong>Réinitialiser</strong></button>
        </p>
    </div>
</form>

{% if not config.extra.disable_registration %}
<form class="form" id="signup" style="display: none;">
    <div id="signupsuccess" style="display:none;" class="notification is-polymny has-text-left">
        Inscritpion terminée ! Un mail contenant un lien permettant de valider votre inscription vous a été envoyé.
    </div>
    <div id="signupnotification" style="display:none;" class="notification is-danger has-text-left">
        <div>Il y a des erreurs dans le formulaire : <div id="signupnotificationcontent"></div></div>
    </div>
    <div class="field">
        <p class="control">
            <input id="signupusername" class="input is-danger" type="text" placeholder="Nom d'utilisateur" required>
        </p>
        <p id="signupusernameerror" class="help has-text-left has-text-danger-dark">A</p>
    </div>
    <div class="field">
        <p class="control">
            <input id="signupemail" class="input" type="email" placeholder="Adresse e-mail" required>
        </p>
        <p id="signupemailerror" class="help has-text-left has-text-danger-dark">A</p>
    </div>
    <div class="field">
        <p class="control">
            <input id="signuppassword" class="input" type="password" placeholder="Mot de passe" autocomplete="new-password" required>
        </p>
        <p class="control mt-3">
            <progress id="signuppasswordlevel" class="progress is-danger is-small" value="0" max="7"></progress>
        </p>
        <p id="signuppasswordlevellabel" class="help has-text-danger-dark has-text-left">A</p>
    </div>
    <div class="field">
        <p class="control">
            <input id="signuppasswordconfirmation" class="input" type="password" autocomplete="new-password" placeholder="Retapez votre mot de passe" required>
        </p>
        <p id="signuppasswordconfirmationerrror" class="help has-text-left has-text-danger-dark">A</p>
    </div>
    <div class="field has-text-left">
        <label class="checkbox">
            <input id="signupaccept" checked=false type="checkbox" class="mr-1">J'ai lu les <a href="/cgu/">conditions d'utilisation</a> et les accepte
        </label>
        <p id="signupaccepterror" class="help has-text-danger-dark has-text-left">Vous devez accepter les conditions d'utilisation pour vous inscrire</p>
    </div>
    <div class="field has-text-left">
        <label class="checkbox">
            <input id="signupsubscribed" checked=false type="checkbox" class="mr-1">Je m'inscris à la newsletter de Polymny Studio
        </label>
    </div>
    <div class="field">
        <p class="control">
            <button id="signupbutton" type="submit" class="button is-polymny is-rounded"><strong>S'inscrire</strong></button>
        </p>
    </div>
</form>
{% endif %}

<script>
    function testCookie() {
        return document.cookie.match(/^(.*;)?\s*EXAUTH2\s*=\s*[^;]+(.*)?$/);
    }

    function isAllowed(c) {
        let regex = /^[0-9a-zA-Z_-]+$/;
        return c.match(regex);
    }

    function toUl(list) {
        let content = "<ul>"
        for (let child of list) {
            content += "<li>" + child + "</li>";
        }
        return content + "</ul>";
    }

    function testUsername(u) {
        let errored = [];
        for (let c of u) {
            if (!isAllowed(c)) {
                errored.push("\"" + c + "\"" + (c === " " ? " (espace)" : ""));
            }
        }

        return errored;
    }

    function testEmail(email) {
        let split = email.split("@");

        if (split.length !== 2) {
            return false;
        }

        if (split[0].length === 0) {
            return false;
        }

        split = split[1].split('.');

        if (split.length < 2) {
            return false;
        }

        if (split[0].length === 0) {
            return false;
        }

        if (split[1].length === 0) {
            return false;
        }

        return true;
    }

    function passwordStrength(password) {
        let level = 1;

        if (/[a-z]/.test(password)) {
            level++;
        }

        if (/[A-Z]/.test(password)) {
            level++;
        }

        if (/[0-9]/.test(password)) {
            level++;
        }

        if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
            level++;
        }

        if (password.length > 9) {
            level++;
        }

        if (password.length > 7) {
            level++;
        }

        if (password.length < 6) {
            level = 1;
        }

        if (password.length === 0) {
            level = 0;
        }

        return level;
    }

    function signUp() {
        signUpButton.classList.add("is-loading");
        signUpButton.disabled = true;

        let xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function() {
            if (xhr.readyState === xhr.DONE) {
                if (xhr.status === 200) {
                    signUpSuccess.style.display = "block";
                } else if (xhr.status === 404) {
                    signUpNotificationContent.innerHTML = toUl(["Ce nom d'utilisateur ou cette adresse e-mail est déjà utilisée"]);
                    signUpNotification.style.display = "block";
                    signUpButton.disabled = false;
                } else {
                    signUpNotificationContent.innerHTML = toUl(["Une erreur inconnue s'est produite"]);
                    signUpNotification.style.display = "block";
                    signUpButton.disabled = false;
                }
                signUpButton.classList.remove('is-loading');
            }
        };

        xhr.open('POST', '{{ config.extra.polymny_url | safe }}api/new-user/');

        xhr.setRequestHeader('Content-Type', 'application/json');

        xhr.send(JSON.stringify({
            username: signUpUsername.value,
            email: signUpEmail.value,
            password: signUpPassword.value,
            subscribed: signUpSubscribed.checked,
        }));
    }


    let loginForm = document.getElementById('login');
    let loginUsername = document.getElementById('loginusername');
    let loginPassword = document.getElementById('loginpassword');
    let loginButton = document.getElementById('loginbutton');
    let loginNotification = document.getElementById('loginnotification');

    let hiddenForm = document.getElementById('hiddenform');
    let hiddenUsername = document.getElementById('hiddenusername');
    let hiddenPassword = document.getElementById('hiddenpassword');

    loginForm.onsubmit = function(event) {
        event.preventDefault();

        loginButton.classList.add("is-loading");
        loginButton.disabled = true;

        let xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function() {
            if (xhr.readyState === xhr.DONE) {
                if (xhr.status === 200) {
                    // Redirect to /login
                    hiddenUsername.value = loginUsername.value;
                    hiddenPassword.value = loginPassword.value;
                    hiddenForm.submit();
                } else if (xhr.status === 401) {
                    loginNotification.innerHTML = "Nom d'utilisateur ou mot de passe incorrect";
                    loginNotification.style.display = "block";
                    loginButton.disabled = false;
                    loginButton.classList.remove('is-loading');
                } else {
                    loginNotification.innerHTML = "Une erreur inconnue s'est produite";
                    loginNotification.style.display = "block";
                    loginButton.disabled = false;
                    loginButton.classList.remove('is-loading');
                }
            }
        };

        xhr.open('POST', '{{ config.extra.polymny_url | safe }}login/');

        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.send("username=" + loginUsername.value + "&password=" + loginPassword.value);
    }

    {% if not config.extra.disable_registration %}
    let signUpForm = document.getElementById('signup');
    let signUpUsername = document.getElementById('signupusername');
    let signUpUsernameError = document.getElementById('signupusernameerror');
    let signUpEmail = document.getElementById('signupemail');
    let signUpEmailError = document.getElementById('signupemailerror');
    let signUpPassword = document.getElementById('signuppassword');
    let signUpPasswordLevel = document.getElementById('signuppasswordlevel');
    let signUpPasswordLevelLabel = document.getElementById('signuppasswordlevellabel');
    let signUpPasswordConfirmation = document.getElementById('signuppasswordconfirmation');
    let signUpPasswordConfirmationError = document.getElementById('signuppasswordconfirmationerrror');
    let signUpAccept = document.getElementById('signupaccept'); signUpAccept.checked = false;
    let signUpAcceptError = document.getElementById('signupaccepterror');
    let signUpSubscribed = document.getElementById('signupsubscribed'); signUpSubscribed.checked = false;
    let signUpNotification = document.getElementById('signupnotification');
    let signUpNotificationContent = document.getElementById('signupnotificationcontent');
    let signUpSuccess = document.getElementById('signupsuccess');
    let openSignUp = document.getElementById('opensignup');
    let signUpButton = document.getElementById('signupbutton');
    let signUpChecks = {};

    function signUpRefresh(checks) {
        signUpButton.disabled = !Object.values(checks).reduce((a, b) => a && b);
    }

    signUpUsername.oninput = function() {
        let errors = [];
        if (signUpUsername.value.length < 4) {
            errors.push("Le nom d'utilisateur doit faire plus de 3 caractères");
        }

        errors.push(...testUsername(signUpUsername.value)
            .map((x) => "Le caractère " + x + " n'est pas accepté dans les noms d'utilisateurs"));

        signUpChecks.username = errors.length === 0;

        if (signUpChecks.username) {
            signUpUsername.classList.remove('is-danger');
            signUpUsernameError.style.visibility = 'hidden';
        } else {
            signUpUsername.classList.add('is-danger');
            signUpUsernameError.style.visibility = 'visible';
            signUpUsernameError.innerHTML = errors[0];
        }

        signUpRefresh(signUpChecks);
    };

    signUpUsername.oninput();

    signUpEmail.oninput = function() {
        signUpChecks.email = testEmail(signUpEmail.value);
        if (signUpChecks.email) {
            signUpEmail.classList.remove('is-danger');
            signUpEmailError.style.visibility = 'hidden';
        } else {
            signUpEmail.classList.add('is-danger');
            signUpEmailError.innerHTML = "L'adresse e-mail est incorrecte";
            signUpEmailError.style.visibility = 'visible';
        }

        signUpRefresh(signUpChecks);
    };

    signUpEmail.oninput();

    signUpPassword.oninput = function() {

        let level = passwordStrength(signUpPassword.value);
        signUpPasswordLevel.value = level;

        signUpPassword.classList.remove('is-danger');
        signUpPasswordLevel.classList.remove('is-danger');
        signUpPasswordLevel.classList.remove('is-warning');
        signUpPasswordLevel.classList.remove('is-success');
        signUpPasswordLevelLabel.classList.remove('has-text-danger-dark');
        signUpPasswordLevelLabel.classList.remove('has-text-warning-dark');
        signUpPasswordLevelLabel.classList.remove('has-text-success-dark');

        if (level < 5) {
            signUpPassword.classList.add('is-danger');
            signUpPasswordLevel.classList.add('is-danger');
            signUpPasswordLevelLabel.classList.add('has-text-danger-dark');
            signUpPasswordLevelLabel.innerHTML = "Complexité du mot de passe insuffisante";
            if (signUpPassword.value.length < 6) {
                signUpPasswordLevelLabel.innerHTML += " : le mot de passe doit contenir au moins 6 caractères";
            }
        } else if (level < 6) {
            signUpPasswordLevel.classList.add('is-warning');
            signUpPasswordLevelLabel.classList.add('has-text-warning-dark');
            signUpPasswordLevelLabel.innerHTML = "Complexité du mot de passe acceptable";
        } else {
            signUpPasswordLevel.classList.add('is-success');
            signUpPasswordLevelLabel.classList.add('has-text-success-dark');
            signUpPasswordLevelLabel.innerHTML = "Bonne complexité du mot de passe";
        }

        signUpChecks.password = level >= 5;
        signUpPasswordConfirmation.oninput();
    };


    signUpPasswordConfirmation.oninput = function() {
        signUpChecks.passwordConfirmation = signUpPassword.value === signUpPasswordConfirmation.value;
        if (signUpChecks.passwordConfirmation) {
            signUpPasswordConfirmation.classList.remove('is-danger');
            signUpPasswordConfirmationError.style.visibility = 'hidden';
        } else {
            signUpPasswordConfirmation.classList.add('is-danger');
            signUpPasswordConfirmationError.innerHTML = "Les deux mots de passe ne correspondent pas";
            signUpPasswordConfirmationError.style.visibility = 'visible';
        }

        signUpRefresh(signUpChecks);
    };

    signUpPassword.oninput();

    signUpAccept.onchange = function() {
        signUpChecks.accepted = signUpAccept.checked;
        signUpAcceptError.style.visibility = signUpChecks.accepted ? "hidden" : "visible";
        signUpRefresh(signUpChecks);
    };

    signUpAccept.onchange();

    signUpForm.onsubmit = function(event) {
        event.preventDefault();
        let errorMessages = [];

        // Test username
        let errors = testUsername(signUpUsername.value);
        errorMessages.push(...errors.map((x) => "Le caractère \"" + x + "\" n'est pas accepté dans les noms d'utilisateurs"));
        if (signUpUsername.length < 3) {
            errorMessages.push("Le nom d'utilisateur doit faire plus de 3 caractères");
        }

        // Test passwords
        if (signUpPassword.value !== signUpPasswordConfirmation.value) {
            errorMessages.push("Les deux mots de passe ne correspondent pas");
        }

        // Test email
        if (!testEmail(signUpEmail.value)) {
            errorMessages.push("L'adresse e-mail est incorrecte");
        }

        // Check terms and conditions
        if (!signUpAccept.checked) {
            errorMessages.push("Vous devez accepter les conditions d'utilisation");
        }

        if (errorMessages.length > 0) {
            signUpNotificationContent.innerHTML = toUl(errorMessages);
            signUpNotification.style.display = "block";
            return;
        } else {
            signUpNotification.style.display = "none";
        }


        // Send sign up request
        signUp();
    };

    openSignUp.addEventListener('click', function() {
        document.getElementById('loggedin').style.display = "none";
        document.getElementById('login').style.display = "none";
        document.getElementById('signup').style.display = "block";
        openSignUp.style.display = "none";
        openNewPassword.style.display = "none";
    });

    {% endif %}

    let openNewPassword = document.getElementById('opennewpassword');
    let newPasswordForm = document.getElementById('newpassword');
    let newPasswordButton = document.getElementById('newpasswordbutton');
    let newPasswordEmail = document.getElementById('newpasswordemail');
    let newPasswordNotification = document.getElementById('newpasswordnotification');
    let newPasswordSuccess = document.getElementById('newpasswordsuccess');

    newPasswordForm.onsubmit = function() {
        event.preventDefault();
        newPasswordButton.classList.add("is-loading");
        newPasswordButton.disabled = true;

        let xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function() {
            if (xhr.readyState === xhr.DONE) {
                if (xhr.status === 200) {
                    newPasswordSuccess.style.display = "block";
                } else {
                    newPasswordNotification.style.display = "block";
                    newPasswordButton.disabled = false;
                }
                newPasswordButton.classList.remove('is-loading');
            }
        };

        xhr.open('POST', '{{ config.extra.polymny_url | safe }}api/request-new-password/');

        xhr.setRequestHeader('Content-Type', 'application/json');

        xhr.send(JSON.stringify({
            email: newPasswordEmail.value,
        }));
    };

    openNewPassword.addEventListener('click', function() {
        document.getElementById('loggedin').style.display = "none";
        document.getElementById('login').style.display = "none";
        document.getElementById('newpassword').style.display = "block";
        {% if not config.extra.disable_registration %}
        openSignUp.style.display = "none";
        {% endif %}
        openNewPassword.style.display = "none";
    });

    if (testCookie()) {
        document.getElementById('loggedin').style.display = "block";
    } else {
        document.getElementById('login').style.display = "block";
    }
</script>
